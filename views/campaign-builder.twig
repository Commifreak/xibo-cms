{#
/**
 * Copyright (C) 2020 Xibo Signage Ltd
 *
 * Xibo - Digital Signage - http://www.xibo.org.uk
 *
 * This file is part of Xibo.
 *
 * Xibo is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * any later version.
 *
 * Xibo is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.
 */
#}
{% extends "authed.twig" %}
{% import "inline.twig" as inline %}
{% import "forms.twig" as forms %}

{% block title %}{% set campaignName = campaign.campaign %}{% trans %}{{ campaignName }} - Campaign Builder{% endtrans %} | {% endblock %}

{% set hideNavigation = "1" %}

{% block pageContent %}
    <div id="campaign-builder"
         data-campaign-id="{{ campaign.campaignId }}">
        <div class="back-button">
            <a id="backBtn" class="btn btn-primary" href="{{ url_for("campaign.view") }}">
                <i class="fa fa-angle-left"></i>
                <span>{{ "Back"|trans }}</span>
            </a>
        </div>

        <div class="widget mt-3">
            <div class="widget-body">
                <div class="row">
                    <div class="col-12">
                        <div class="campaign-title">
                            <h1>{{ campaign.campaign }}</h1>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <form id="campaign-builder-form-details" class="XiboForm form-horizontal"
                             method="put"
                             action="{{ url_for("campaign.edit", {id: campaign.campaignId}) }}">

                            {% if currentUser.featureEnabled('folder.view') %}
                                <div class="form-group row">
                                    <label class="col-sm-2 control-label">{% trans "Current Folder" %}</label>
                                    <div class="col-sm-10" style="padding-top: 7px">
                                        <span id="originalFormFolder"></span>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="col-sm-2 control-label">{% trans "Move to Selected Folder:" %}</label>
                                    <div class="col-sm-10">
                                        <button type="button" class="btn btn-info" id="select-folder-button" data-toggle="modal" data-target="#folder-tree-form-modal">{% trans "Select Folder" %}</button>
                                        <span id="selectedFormFolder"></span>
                                    </div>
                                </div>
                                {{ forms.hidden('folderId', campaign.folderId) }}
                            {% endif %}

                            {% set title %}{% trans "Name" %}{% endset %}
                            {% set helpText %}{% trans "The Name for this Campaign" %}{% endset %}
                            {{ forms.input("name", title, campaign.campaign, helpText) }}

                            {% set title %}{% trans "Start Date" %}{% endset %}
                            {% set helpText %}{% trans "Select the start date for this campaign" %}{% endset %}
                            {{ forms.date("startDt", title, campaign.getStartDt(), helpText, "starttime-control", "required", "") }}

                            {% set title %}{% trans "End Date" %}{% endset %}
                            {% set helpText %}{% trans "Select the end date for this campaign" %}{% endset %}
                            {{ forms.date("endDt", title, campaign.getEndDt(), helpText, "endtime-control", "required", "") }}

                            {% set title %}{% trans "Display" %}{% endset %}
                            {% set helpText %}{% trans "Please select one or more displays / groups for this event to be shown on." %}{% endset %}
                            {% set attributes = [
                                { name: "data-search-url", value:  url_for("displayGroup.search") },
                                { name: "data-trans-groups", value:  "Groups"|trans },
                                { name: "data-trans-display", value:  "Display"|trans },
                                { name: "data-search-term", value: "displayGroup" },
                                { name: "data-id-property", value: "displayGroupId" },
                                { name: "data-text-property", value: "displayGroup" },
                            ] %}
                            {{ forms.dropdown("displayGroupIds[]", "dropdownmulti", title, displayGroupIds, displayGroups, "displayGroupId", "displayGroup", helpText, "", "", "", "", attributes) }}

                            {% set title %}{% trans "Target Plays" %}{% endset %}
                            {% set helpText %}{% trans "What are the target number of plays for this Campaign over its entire playtime" %}{% endset %}
                            {{ forms.number("playCount", title, campaign.playCount, helpText) }}

                            {% if currentUser.featureEnabled("tag.tagging") %}
                                {% set title %}{% trans "Tags" %}{% endset %}
                                {% set helpText %}{% trans "Tags for this Campaign - Comma separated string of Tags or Tag|Value format. If you choose a Tag that has associated values, they will be shown for selection below." %}{% endset %}
                                {{ forms.inputWithTags("tags", title, campaign.tags, helpText, 'tags-with-value') }}

                                <p id="loadingValues" style="margin-left: 17%"></p>

                                {% set title %}{% trans "Tag value" %}{% endset %}
                                {{ forms.dropdown("tagValue", "single", title, "", options, "key", "value") }}

                                <div id="tagValueContainer">
                                    {% set title %}{% trans "Tag value" %}{% endset %}
                                    {% set helpText %}{% trans "Please provide the value for this Tag and confirm by pressing enter on your keyboard." %}{% endset %}
                                    {{ forms.input("tagValueInput", title, "", helpText) }}
                                </div>

                                <div id="tagValueRequired" class="alert alert-info">
                                    <p>{% trans "This tag requires a set value, please select one from the Tag value dropdown or provide Tag value in the dedicated field." %}</p>
                                </div>
                            {% endif %}

                            {{ forms.button("Save"|trans, "submit", null, null, null, "btn-success") }}
                        </form>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col-md-12">
                                <table id="table-campaign-builder-layout-assignments" class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>{% trans "ID" %}</th>
                                        <th>{% trans "Name" %}</th>
                                        <th>{% trans "Duration" %}</th>
                                        <th>{% trans "Day Parts" %}</th>
                                        <th>{% trans "Geofence" %}</th>
                                        <th></th>
                                    </tr>
                                    </thead>
                                    <tbody>

                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                {# Layouts #}
                                {% set attributes = [
                                    { name: "data-search-url", value:  url_for("layout.search") },
                                    { name: "data-search-term", value: "layout" },
                                    { name: "data-search-term-tags", value: "tags" },
                                    { name: "data-trans-layout", value: "Layout"|trans },
                                    { name: "data-id-property", value: "layoutId" },
                                    { name: "data-text-property", value: "layout" },
                                    { name: "data-placeholder--id", value: null },
                                    { name: "data-placeholder--value", value: "Add a layout"|trans },
                                ] %}

                                {% set title %}{% trans "Layout" %}{% endset %}
                                {% set helpText %}{% trans "Please select a Layout" %}{% endset %}
                                {{ forms.dropdown("layoutId", "single", title, event.campaignId, null, "campaignId", "campaign", helpText, "layout-control", "", "", "", attributes) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javaScript %}
    <script src="{{ theme.rootUri() }}dist/campaignBuilder.bundle.min.js?v={{ version }}&rev={{revision}}"></script>
    <script type="text/javascript">
        {# Custom translations #}
        {% autoescape "js" %}
            {# Insert custom translations here #}
            const campaignBuilderTrans = {
              addLayoutButton: '{{ "Add Layout"|trans }}',
            };
        {% endautoescape %}
    </script>
{% endblock %}

{% block javaScriptTemplates %}
    <script type="text/x-handlebars-template" id="campaign-builder-layout-add-form-template">
        <form action="{{ url_for("campaign.assign.layout", {id: campaign.campaignId}) }}" class="form-horizontal">
            <input type="hidden" name="layoutId" value="{% verbatim %}{{layoutId}}{% endverbatim %}">

                {% set title %}{% trans "Days of the week" %}{% endset %}
                {% set helpText %}{% trans "Which days of the week should the layout be active?" %}{% endset %}
                {% set monday %}{% trans "Monday" %}{% endset %}
                {% set tuesday %}{% trans "Tuesday" %}{% endset %}
                {% set wednesday %}{% trans "Wednesday" %}{% endset %}
                {% set thursday %}{% trans "Thursday" %}{% endset %}
                {% set friday %}{% trans "Friday" %}{% endset %}
                {% set saturday %}{% trans "Saturday" %}{% endset %}
                {% set sunday %}{% trans "Sunday" %}{% endset %}
                {% set options = [
                    { id: 1, name: "Monday"|trans },
                    { id: 2, name: "Tuesday"|trans },
                    { id: 3, name: "Wednesday"|trans },
                    { id: 4, name: "Thursday"|trans },
                    { id: 5, name: "Friday"|trans },
                    { id: 6, name: "Saturday"|trans },
                    { id: 7, name: "Sunday"|trans },
                ] %}
            {{ forms.dropdown("daysOfWeek[]", "dropdownmulti", title, event.recurrenceRepeatsOn, options, "id", "name", helpText) }}

            {# Day Part #}
            {% set attributes = [
                { name: "data-search-url", value:  url_for("daypart.search") ~ "?isAlways=0&isCustom=0" },
                { name: "data-search-term", value: "name" },
                { name: "data-id-property", value: "dayPartId" },
                { name: "data-text-property", value: "name" },
                { name: "data-placeholder--id", value: null },
                { name: "data-placeholder--value", value: "" },
            ] %}
            {% set title %}{% trans "Dayparting" %}{% endset %}
            {% set helpText %}{% trans "Should this layout only be shown on selected day parts?" %}{% endset %}
            {{ forms.dropdown("dayPartId", "single", title, null, null, "dayPartId", "name", helpText, "", "", "", "", attributes) }}

            {{ forms.hidden("geoLocation", event.geoLocation) }}

            {{ forms.message("Draw areas on the map where you want this layout to play."|trans) }}

            <div id="campaign-builder-map"
                 data-map-tile-server="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                 data-map-lat="{{ settings.DEFAULT_LAT }}"
                 data-map-long="{{ settings.DEFAULT_LONG }}"
                 data-map-zoom="13"
                 style="height: 500px; width: 100%"></div>
        </form>
    </script>
{% endblock %}
